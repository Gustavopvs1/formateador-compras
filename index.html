<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de √ìrdenes de Compra</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ff8282 0%, #d87777 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
   
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            margin-bottom: 20px;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .header-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        h1 {
            color: #2d3748;
            font-size: 28px;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
        }
        
        .upload-area:hover {
            border-color: #4e0000;
            background: #edf2f7;
        }
        
        .upload-area.dragover {
            border-color: #840000;
            background: #e6fffa;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ae0000;
        }
        
        .upload-text {
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            color: #a0aec0;
            font-size: 14px;
        }
        
        .file-name {
            margin-top: 15px;
            color: #667eea;
            font-weight: 600;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8b0000 0%, #c60000 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(72, 187, 120, 0.4);
        }
        
        .btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
        }

        .actions-row .btn {
            width: auto;
            margin-top: 0;
        }

        .download-buttons {
            display: none;
            gap: 10px;
        }

        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .alert-error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        
        .alert-success {
            background: #c6f6d5;
            border: 1px solid #68d391;
            color: #22543d;
        }
        
        .alert-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .preview {
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .preview-header {
            background: #f7fafc;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #2d3748;
        }

        .column-controls {
        margin-top: 20px;
        margin-bottom: 10px;
        padding: 10px 12px;
        background: #f7fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .column-controls-title {
        font-size: 14px;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 8px;
    }

    .column-controls-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .column-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: white;
        border: 1px solid #cbd5e0;
        font-size: 13px;
        color: #4a5568;
        cursor: pointer;
        user-select: none;
    }

    .column-pill input {
        margin: 0;
    }

        
        .table-container {
            max-height: 350px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 8px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .table-container table thead th {
            position: sticky;
            top: 0;
            background: #f7fafc;
            z-index: 2;
        }

        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .instructions {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .instructions h2 {
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            color: #4a5568;
            line-height: 1.8;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        input[type="file"] {
            display: none;
        }

        .two-columns {
            display: flex;
            gap: 20px;
        }

        .left-panel { flex: 3; }
        .right-panel { flex: 1.2; }

        .left-panel, .right-panel {
            min-width: 0;
        }

        .instructions {
            padding: 20px !important;
            font-size: 14px;
        }
        .instructions h2 {
            font-size: 18px;
        }
        .instructions ol {
            padding-left: 18px;
        }

        .preview-summary {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 13px;
    color: #4a5568;
}

.preview-summary span {
    background: #edf2f7;
    padding: 4px 10px;
    border-radius: 999px;
}

.preview-search {
    margin-top: 10px;
    margin-bottom: 5px;
}

.preview-search input {
    width: 100%;
    max-width: 280px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid #cbd5e0;
    font-size: 13px;
}

.preview-search input:focus {
    outline: none;
    border-color: #8b0000; /* rojo que ya usas */
    box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.15);
}

/* Layout responsive para pantallas peque√±as */
@media (max-width: 900px) {
    .two-columns {
        flex-direction: column;
    }
    .right-panel {
        margin-top: 20px;
    }
}


    </style>
</head>
<body>
    <div class="container two-columns">
        <div class="left-panel">
            <div class="card">
                <div class="header">
                    <div class="header-icon">üìä</div>
                    <h1>Procesador de √ìrdenes de Compra</h1>
                </div>
                
                <p class="subtitle">
                    Sube tu archivo de orden de compra (formato antiguo o nuevo) 
                    y genera autom√°ticamente el archivo procesado para distribuci√≥n en formato Excel.
                </p>

                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">Click para subir o arrastra el archivo aqu√≠</div>
                    <div class="upload-hint">Archivos Excel (.xls, .xlsx)</div>
                    <div class="file-name" id="fileName"></div>
                </div>
                    <input type="file" id="fileInput" accept=".xls,xlsx">

                    <div class="actions-row">
                        <button class="btn btn-primary" id="processBtn" disabled>
                            <span>üìÑ</span>
                            <span>Procesar Archivo</span>
                        </button>

                        <div id="downloadButtons" class="download-buttons"></div>
                    </div>

                    <div id="alertContainer"></div>
                    <div id="previewContainer"></div>

            </div>
        </div>

        <div class="right-panel">
            <div class="instructions">
                <h2>üìã Instrucciones:</h2>
                <ol>
                    <li>Sube el archivo Excel de orden de compra (.xls o .xlsx)</li>
                    <li>Haz clic en "Procesar Archivo" para convertirlo</li>
                    <li>Revisa la vista previa de los datos procesados</li>
                    <li>Descarga el archivo Excel generado</li>
                    <li>El archivo generado estar√° listo para usar en tus procesos</li>
                </ol>
            </div>
        </div>
    </div>

<script>
    let currentFile = null;
    let processedData = [];
    let originalFileName = '';
    let selectedColumns = ['Tienda', 'Cantidad', 'Producto', 'Sku']; // columnas por defecto
    let filterText = '';


    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const processBtn = document.getElementById('processBtn');
    const alertContainer = document.getElementById('alertContainer');
    const previewContainer = document.getElementById('previewContainer');
    const downloadButtons = document.getElementById('downloadButtons');

    // Drag and drop events
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        if (!file.name.match(/\.(xls|xlsx)$/i)) {
            showAlert('Por favor selecciona un archivo Excel (.xls o .xlsx)', 'error');
            return;
        }
        currentFile = file;

        originalFileName = file.name.replace(/\.[^.]+$/, '');
        fileName.textContent = `‚úì ${file.name}`;
        processBtn.disabled = false;
        alertContainer.innerHTML = '';
        previewContainer.innerHTML = '';

        filterText = '';

        if (downloadButtons) {
            downloadButtons.style.display = 'none';
            downloadButtons.innerHTML = '';
        }
    }

    processBtn.addEventListener('click', processFile);

    async function processFile() {
        if (!currentFile) return;

        processBtn.disabled = true;
        processBtn.innerHTML = '<div class="spinner"></div><span>Procesando...</span>';
        alertContainer.innerHTML = '';
        previewContainer.innerHTML = '';

        if (downloadButtons) {
            downloadButtons.style.display = 'none';
            downloadButtons.innerHTML = '';
        }

        try {
            const data = await readExcelFile(currentFile);
            processedData = parseOrderData(data);
            
            if (processedData.length === 0) {
                throw new Error('No se encontraron datos v√°lidos en el archivo');
            }

        showAlert(`¬°Procesamiento exitoso! Se procesaron ${processedData.length} registros`, 'success');
        showPreview(processedData);


        } catch (error) {
            showAlert(`Error al procesar el archivo: ${error.message}`, 'error');
        } finally {
            processBtn.disabled = false;
            processBtn.innerHTML = '<span>üìÑ</span><span>Procesar Archivo</span>';
        }
    }

    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                    resolve(jsonData);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = () => reject(new Error('Error al leer el archivo'));
            reader.readAsArrayBuffer(file);
        });
    }

    // ===== Helpers =====
    function normalizeText(value) {
        return String(value || "")
            .trim()
            .toUpperCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036F]/g, ""); // quita acentos
    }

    function isEmptyCell(value) {
        return value === undefined || value === null || String(value).trim() === "";
    }

    function isModelCode(value) {
            const s = String(value || "").trim().toUpperCase();
            // permitir letras, n√∫meros y guiones
            if (!/^[A-Z0-9-]+$/.test(s)) return false;
            // longitud razonable para c√≥digos de producto
            if (s.length < 3 || s.length > 20) return false;
            // al menos una letra
            if (!/[A-Z]/.test(s)) return false;
            // YA NO exigimos n√∫meros
            return true;
        }

    // Detectar formato nuevo por encabezados Ean / Precio / Sku / Descripci√≥n
    function detectNewFormat(data) {
        for (let i = 0; i < data.length; i++) {
            const row = data[i] || [];
            const normRow = row.map(normalizeText);

            const hasEan = normRow.includes("EAN");
            const hasSku = normRow.includes("SKU");
            const hasDesc = normRow.includes("DESCRIPCION") || normRow.includes("DESCRIPCI√ìN");
            const hasPrecio = normRow.includes("PRECIO");

            if (hasEan && hasSku && hasDesc && hasPrecio) {
                return true;
            }
        }
        return false;
    }


    function parseOrderData(data) {
        const isNew = detectNewFormat(data);
        if (isNew) {
            return parseNewFormat(data);
        } else {
            return parseOldFormat(data);
        }
    }

    function parseNewFormat(data) {
    const result = [];
    let currentEan = null;
    let currentProducto = null;
    let inDistribucion = false;
    let currentMeta = {};
    let distribOrder = 'store_first'; // 'store_first' | 'qty_first'

    const isDigits = (v) => /^\d+$/.test(String(v ?? '').trim());
    const isStoreCode = (v) => {
        const s = String(v ?? '').trim();
        return isDigits(s) && s.length >= 1 && s.length <= 5;
    };
    const isQty = (v) => {
        const n = parseInt(String(v ?? '').trim(), 10);
        return !isNaN(n) && n > 0;
    };

    for (let i = 0; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length === 0) continue;

        // 1) Encabezados del bloque (Ean, Precio, ...)
        if (String(row[0]).trim() === 'Ean' && i + 1 < data.length) {
            const headerRow = row.map(v => String(v || '').trim());
            const valueRow = (data[i + 1] || []).map(v => v);

            currentMeta = {};
            for (let c = 0; c < headerRow.length; c++) {
                const colName = headerRow[c];
                if (!colName) continue;
                currentMeta[colName] = valueRow[c];
            }

            currentEan = String(currentMeta['Ean'] || '').trim();

            const estilo = currentMeta['Estilo'] || currentMeta['ESTILO'];
            if (estilo && isModelCode(estilo)) {
                currentProducto = String(estilo).trim();
            } else {
                currentProducto = null;
            }

            inDistribucion = false;
            continue;
        }

        const firstCell = String(row[0] || '').trim();

        // 2) Detectar inicio de distribuci√≥n y capturar el ORDEN a partir del encabezado
        if (firstCell.includes('Distribuci√≥n') || firstCell === 'Tienda' || firstCell === 'Cantidad') {
            const normRow = row.map(v => String(v ?? '').trim().toLowerCase());
            const idxTienda = normRow.indexOf('tienda');
            const idxCantidad = normRow.indexOf('cantidad');

            if (idxTienda !== -1 && idxCantidad !== -1) {
                distribOrder = (idxTienda < idxCantidad) ? 'store_first' : 'qty_first';
            } else if (firstCell === 'Cantidad') {
                distribOrder = 'qty_first';
            } else {
                distribOrder = 'store_first';
            }

            inDistribucion = true;
            continue;
        }

        // 3) Buscar c√≥digo de producto SOLO fuera de la distribuci√≥n
        if (!inDistribucion && !currentProducto) {
            for (let j = 0; j < row.length; j++) {
                const cell = String(row[j]).trim();
                if (isModelCode(cell)) {
                    currentProducto = cell;
                    break;
                }
            }
        }

        // 4) Procesar filas de distribuci√≥n seg√∫n el orden detectado
        if (inDistribucion && currentEan && currentProducto) {
            const filtered = row.filter(v => String(v ?? '').trim() !== '');

            for (let k = 0; k < filtered.length - 1; k += 2) {
                const a = filtered[k];
                const b = filtered[k + 1];

                let tiendaVal, cantidadVal;

                if (distribOrder === 'store_first') {
                    tiendaVal = a;
                    cantidadVal = b;
                } else {
                    cantidadVal = a;
                    tiendaVal = b;
                }

                const tiendaStr = String(parseInt(String(tiendaVal ?? '').trim(), 10));
                const cantNum = parseInt(String(cantidadVal ?? '').trim(), 10);

                if (!isStoreCode(tiendaStr)) continue;
                if (isNaN(cantNum) || cantNum <= 0) continue;

                const rowObj = {
                    Tienda: tiendaStr,
                    Cantidad: cantNum,
                    Producto: currentProducto,
                    Sku: currentMeta['Sku'] || currentMeta['SKU'] || currentEan
                };

                Object.keys(currentMeta).forEach(colName => {
                    if (!(colName in rowObj)) {
                        rowObj[colName] = currentMeta[colName];
                    }
                });

                result.push(rowObj);
            }
        }

        // 5) Reset al arrancar otro bloque
        if (firstCell === 'Ean' || firstCell === 'Precio') {
            inDistribucion = false;
        }
    }

    return result;
}


    function parseOldFormat(data) {
        const result = [];
        const nRows = data.length;
        if (!nRows) return result;

        let headerRowIndex = -1;
        const headerNamesByIndex = {};

        for (let r = 0; r < nRows; r++) {
            const row = data[r] || [];
            if (!row.length) continue;

            const norm = row.map(normalizeText);
            const hasModelo = norm.some(v => v.includes("MODELO"));
            const hasEan = norm.some(v =>
                v.includes("CODIGO EAN") ||
                v.includes("C√ìDIGO EAN") ||
                (v.includes("CODIGO") && v.includes("EAN"))
            );
            const hasSku = norm.some(v => v.includes("SKU"));
            const hasDescripcion = norm.some(v =>
                v.includes("DESCRIPCION") ||
                v.includes("DESCRIPCI√ìN")
            );

            if (hasModelo && (hasEan || hasSku || hasDescripcion)) {
                headerRowIndex = r;
                for (let c = 0; c < row.length; c++) {
                    const rawHeader = String(row[c] || "").trim();
                    if (!rawHeader) continue;
                    let cleanName = rawHeader.replace(/:$/, "").trim(); // quitar ":" final
                    headerNamesByIndex[c] = cleanName;
                }
                break;
            }
        }

        // Regex anterior (por si acaso) pero en realidad usamos m√°s isModelCode
        const modelRegex = /^(MUC|MUCM|MMP|MMPS)[A-Z0-9]+$/i;

        for (let i = 0; i < nRows; i++) {
            const row = (data[i] || []);
            if (!row.length) continue;

            let foundModel = null;
            for (let c = 0; c < row.length; c++) {
                const v = String(row[c] || "").trim();
                if (modelRegex.test(v) || isModelCode(v)) {
                    foundModel = v;
                    break;
                }
            }

            if (!foundModel) continue;
            const currentModel = foundModel;

            let productMeta = {};
            if (headerRowIndex >= 0) {
                for (let c = 0; c < row.length; c++) {
                    const headerName = headerNamesByIndex[c];
                    if (!headerName) continue;
                    const cellVal = row[c];
                    if (isEmptyCell(cellVal)) continue;
                    productMeta[headerName] = cellVal;
                }
            }

            // ---- SKU / EAN en la misma fila ----
            let currentSku = null;
            let eanCandidate = null;
            const numericCodes = [];

            for (let c = 0; c < row.length; c++) {
                const v = String(row[c] || "").trim();
                if (/^\d+$/.test(v)) {
                    numericCodes.push(v);
                }
            }

            // SKU: 9‚Äì11 d√≠gitos, EAN: 12‚Äì14
            for (const code of numericCodes) {
                if (code.length >= 9 && code.length <= 11 && !currentSku) {
                    currentSku = code;
                } else if (code.length >= 12 && code.length <= 14 && !eanCandidate) {
                    eanCandidate = code;
                }
            }
            if (!currentSku && eanCandidate) {
                currentSku = eanCandidate;
            }

            // Rellenar metadatos con SKU/EAN si no ven√≠an en columnas
            if (currentSku && !("SKU" in productMeta)) {
                productMeta["SKU"] = currentSku;
            }
            if (eanCandidate &&
                !("C√ìDIGO EAN" in productMeta) &&
                !("CODIGO EAN" in productMeta)) {
                productMeta["C√ìDIGO EAN"] = eanCandidate;
            }

            // ---- Filas de distribuci√≥n debajo de este producto ----
            for (let r = i + 1; r < nRows; r++) {
                const drow = data[r] || [];
                if (!drow.length) continue;

                // ¬øNuevo producto?
                let hasNewModel = false;
                for (let c = 0; c < drow.length; c++) {
                    const v = drow[c];
                    if (modelRegex.test(String(v || "").trim()) || isModelCode(v)) {
                        hasNewModel = true;
                        break;
                    }
                }
                if (hasNewModel) {
                    i = r - 1; // que el for principal procese este nuevo
                    break;
                }

                const filtered = drow.filter(v => !isEmptyCell(v));
                if (filtered.length < 2) continue;

                const hasTienda = filtered.some(v => normalizeText(v).includes("TIENDA"));
                const hasCantidad = filtered.some(v => normalizeText(v).includes("CANTIDAD"));
                if (hasTienda && hasCantidad) continue;

                // Emular array_chunk([TIENDA,CANTIDAD,TIENDA,CANTIDAD],2)
                for (let k = 0; k < filtered.length - 1; k += 2) {
                    const tiendaVal = filtered[k];
                    const cantVal = filtered[k + 1];

                    const tiendaStr = String(tiendaVal || "").trim();
                    const cantNum = parseInt(cantVal, 10);

                    if (!tiendaStr || isNaN(cantNum) || cantNum <= 0) continue;
                    if (!/^\d+$/.test(tiendaStr)) continue;
                    if (tiendaStr.length > 4) continue;

                    const rowObj = {
                        Tienda: tiendaStr,
                        Cantidad: cantNum,
                        Producto: currentModel,
                        Sku: currentSku ? String(currentSku) : ""
                    };

                    // A√±adir columnas extra de producto si existen (MODELO, C√ìDIGO EAN, DESCRIPCI√ìN, COLOR, TALLA, etc.)
                    Object.keys(productMeta).forEach(colName => {
                        if (!(colName in rowObj)) {
                            rowObj[colName] = productMeta[colName];
                        }
                    });

                    result.push(rowObj);
                }
            }
        }

        return result;
    }


        // ===== UI: alertas, preview y descarga =====
        function showAlert(message, type) {
            const icon = type === 'error' ? '‚ö†Ô∏è' : '‚úÖ';
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    <div class="alert-icon">${icon}</div>
                    <div>${message}</div>
                </div>
            `;
        }


        function applyFilter(data) {
        if (!filterText) return data;
         const q = filterText.toLowerCase();

        return data.filter(row =>
            Object.values(row).some(v =>
             String(v ?? '').toLowerCase().includes(q)
         )
        );
    }   

function showPreview(data) {
    if (!data || data.length === 0) {
        previewContainer.innerHTML = '';
        showDownloadButton();
        return;
    }

    // Detectar todas las columnas disponibles en processedData
    const colSet = new Set();
    data.forEach(row => {
        Object.keys(row).forEach(k => colSet.add(k));
    });
    const allColumns = Array.from(colSet);

    // Mantener selectedColumns solo con columnas existentes
    selectedColumns = (selectedColumns || []).filter(c => allColumns.includes(c));

    // Si se vac√≠a, tomamos un default
    if (selectedColumns.length === 0) {
        const preferred = ['Tienda', 'Cantidad', 'Producto', 'Sku'];
        preferred.forEach(c => {
            if (allColumns.includes(c)) selectedColumns.push(c);
        });
        // Si ni siquiera hay las preferidas, mostramos todas
        if (selectedColumns.length === 0) {
            selectedColumns = allColumns.slice();
        }
    }

    // Aplicar filtro de b√∫squeda
    const filteredData = applyFilter(data);

    // ===== Resumen r√°pido =====
    const tiendas = new Set();
    const productos = new Set();
    let totalCantidad = 0;

    filteredData.forEach(row => {
        if (row.Tienda !== undefined && row.Tienda !== '') {
            tiendas.add(String(row.Tienda));
        }
        if (row.Producto !== undefined && row.Producto !== '') {
            productos.add(String(row.Producto));
        }
        const val = parseFloat(row.Cantidad);
        if (!isNaN(val)) totalCantidad += val;
    });

    const controlsHtml = `
        <div class="column-controls">
            <div class="column-controls-title">Columnas a mostrar</div>
            <div class="column-controls-list">
                ${allColumns.map(col => `
                    <label class="column-pill">
                        <input type="checkbox" class="column-toggle" data-col="${col}"
                            ${selectedColumns.includes(col) ? 'checked' : ''}>
                        <span>${col}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `;

    const summaryHtml = `
        <div class="preview-summary">
            <span><strong>Registros:</strong> ${filteredData.length} / ${data.length}</span>
            <span><strong>Tiendas:</strong> ${tiendas.size}</span>
            <span><strong>Productos:</strong> ${productos.size}</span>
            <span><strong>Total piezas:</strong> ${totalCantidad}</span>
        </div>
        <div class="preview-search">
            <input type="text" id="searchInput"
                   placeholder="Buscar en la vista previa..."
                   value="${filterText}">
        </div>
    `;

    const tableHtml = `
        <div class="preview">
            <div class="preview-header">
                Vista previa (${filteredData.length} registros)
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            ${selectedColumns.map(col => `<th>${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(row => `
                            <tr>
                                ${selectedColumns.map(col => `<td>${row[col] ?? ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // Pintamos controles + resumen + tabla
    previewContainer.innerHTML = controlsHtml + summaryHtml + tableHtml;

    // Listeners de columnas
    const toggles = previewContainer.querySelectorAll('.column-toggle');
    toggles.forEach(input => {
        input.addEventListener('change', (e) => {
            const col = e.target.getAttribute('data-col');
            if (e.target.checked) {
                if (!selectedColumns.includes(col)) {
                    selectedColumns.push(col);
                }
            } else {
                // No dejar al usuario sin ninguna columna
                if (selectedColumns.length === 1) {
                    e.target.checked = true;
                    return;
                }
                selectedColumns = selectedColumns.filter(c => c !== col);
            }
            // Re-render de la vista previa con las nuevas columnas
            showPreview(processedData);
        });
    });

searchInput.addEventListener('input', (e) => {
    const caretPos = e.target.selectionStart;
    filterText = e.target.value || '';

    showPreview(processedData);

    // Restaurar foco y posici√≥n del cursor
    const newInput = document.getElementById('searchInput');
    if (newInput) {
        newInput.focus();
        newInput.setSelectionRange(caretPos, caretPos);
    }
});

    // Botones de descarga (arriba, donde los pusimos)
    showDownloadButton();
}


    function showDownloadButton() {
        if (!downloadButtons) return;

        // Si no hay datos, ocultamos el contenedor
        if (!processedData || processedData.length === 0) {
            downloadButtons.style.display = 'none';
            downloadButtons.innerHTML = '';
            return;
        }

        // Limpiar y volver a crear los botones
        downloadButtons.innerHTML = '';

        const btnExcel = document.createElement('button');
        btnExcel.className = 'btn btn-success';
        btnExcel.innerHTML = '<span>‚¨áÔ∏è</span><span>Descargar Excel</span>';
        btnExcel.onclick = downloadExcel;

        const btnPDF = document.createElement('button');
        btnPDF.className = 'btn btn-primary';
        btnPDF.innerHTML = '<span>üßæ</span><span>Descargar PDF</span>';
        btnPDF.onclick = downloadPDF;

        downloadButtons.appendChild(btnExcel);
        downloadButtons.appendChild(btnPDF);
        downloadButtons.style.display = 'flex';
    }

    function downloadExcel() {
        // Construimos un arreglo solo con las columnas seleccionadas
        const dataToExport = processedData.map(row => {
            const obj = {};
            selectedColumns.forEach(col => {
                obj[col] = row[col];
            });
            return obj;
        });

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Ordenes');

        const base = originalFileName || 'orden_procesada';
        const filename = `${base} - formateado.xlsx`;

        XLSX.writeFile(wb, filename);
    }


function downloadPDF() {
    if (!processedData || processedData.length === 0) {
        showAlert('No hay datos para exportar a PDF', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt');

    doc.setFontSize(14);
    doc.text('Orden procesada - Distribuci√≥n por tienda', 40, 40);

    const head = [selectedColumns];
    const body = processedData.map(row =>
        selectedColumns.map(col => String(row[col] ?? ''))
    );

    doc.autoTable({
        startY: 60,
        head,
        body,
        styles: { fontSize: 8, cellPadding: 3 },
        headStyles: { fillColor: [102, 126, 234], textColor: 255 }
    });

    const base = originalFileName || 'orden_procesada';
    const filename = `${base} - formateado.pdf`;

    doc.save(filename);
}

</script>
</body>
</html>
